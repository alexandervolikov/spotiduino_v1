# Руководство пользователя (версия 1.5.0)

## Общая информация

### Чипы

В системе используются чипы Ntag215. Их памяти хватает на запись 120 отметок c записью полного времени (год-месяц-день-час-минута-секунда). Могут быть выполнены в разном форм-факторе. Отдельные чипы могут неуверенно срабатывать на станциях, зависит от площади антенны.

### Базовые станции

Представляют собой небольшие коробочки с фланцами, весят около 150 грамм. Питание от батарей АА или от аккумулятора 14500, в зависимости от режима работы и типа батареек хватает от 15 дней до 1 года. Кнопок и другого интерфейса на станции нет, весь обмен информацией, запись чипов происходит в бесконтактном режиме, оптимальная зона срабатывания 0-1 см над станцией. В станции установлены часы, обладающие малой погрешностью хода, но станции не являются прибором точного времени, время нужно регулярно корректировать. 
Для обеспечения более длительной работы от батареи базовые станции могут работать в трех режимах:

*	Спящий режим. Для хранения станций между соревнованиями. Опрос чипа происходит раз в 25 секунд. Практически не потребляют энергию. Батарей хватит более чем на 1 год. Для перевода в данный режим используются специально записанные мастер-чипы. Вывод осуществляется прикладыванием любого чипа.
*	Режим ожидания. Опрос чипа раз в 1 секунду. По умолчанию, при отметке чипом переходит в рабочий режим. Батарей хватит примерно на 45 дней.
*	Рабочий режим. Опрос чипа раз в 0.25 секунд. Самый быстрый режим отметки. Батарей хватит на 15 дней. По умолчанию, при бездействии более 4 часов переходит в режим ожидания.

Базовые станции в зависимости от заданного им номера (число от 1 до 255) могут выполнять разные функции:

* 1-239 - обычные станции отметки. При поднесении чипа записывают в него новые данные и выдают сигнал. При повторном поднесении чипа не производят запись, выдают сигнал. В режиме работы станции старта/финиша не производят отметку и не сигналят для чипов, которые не стартовали или не финишировали.
* 240 – станция старта. В режиме работы станции старта/финиша не производят отметку и не сигналят, если чип не пустой. В обычном режиме работают как обычные базовые станции
* 245 – станция финиша. Работает как обычная базовая станция
* 248 – станция проверки. Если чип пустой и время его инициализации/очистки не отстает более чем на месяц от текущего, станция пикает один раз, иначе – три. Станция ничего не записывает на чип и работает по скорости как обычная, так что на ней участники также могут потренироваться в отметке.
* 249 – станция очистки. Стирает весь чип, оставляя неизменным номер, а также обновляет время инициализации на чипе. При поднесении чипа загорается светодиод и горит все время процедуры очистки, звуковой сигнал говорит об успешности процедуры. При поднесении повторно только что очищенного чипа станция просто издает сигнал.

### Мастер станция

Станция с разъемом USB для подключения к компьютеру нужна для настройки системы, записи и считывания чипов.

## Инструкция для участников

Данную инструкцию целесообразно распечатать крупным шрифтом и повесить для ознакомления участникам на соревнованиях.

*	Для отметки нужно поднести чип к области над меткой на станции.
*	В случае успешной отметки станция издаст звуковой сигнал и (или) два раза мигнет светодиодом
* 	Оптимальный диапазон срабатывания – 0-1 см над оранжевой наклейкой. 
*	Если подносить чип вплотную, или если чип далеко от станции, отметка может сработать не с первого раза. 
*	При отметке не нужно двигать чип из стороны в сторону, это затрудняет чтение и запись чипа.
*	Если не получилось отметиться, уберите чип и вновь поднесите его, медленно опуская его к станции над меткой.
*	Время отметки составляет от 0,06 до 0,4 секунды, если станция находится в рабочем режиме.
*	Если Вы пришли на станцию первым, её, возможно, нужно разбудить, время отметки в таком случае составит от 0,06 до 1,2 секунды.
*	Отметка бесконтактная, ни на что нажимать не нужно.
*	При попытке повторной отметки станция произведет более длительный сигнал без записи новой отметки. Если не уверены, отметились ли вы с первого раза, стоит повторить.
*	Если станция ведёт себя неадекватно (самопроизвольно сигналит, сигналит спустя 5 секунд после отметки и т.п.) – сообщите постановщикам


## Инструкция для постановщиков

Для работы со станциями необходимо использовать программу SportiduinoPQ, это подготовка чипов, настройка станций. 

### Подключение мастер-станции

Для подключения станции нужно нажать кнопку Connect. Если подключить станцию не удается, проверьте правильность соединения. Проблемы могут возникнуть, если в системе используется другое устройство, связанное через com порт. В таком случае нужно через Панель управления - Диспетчер устройств выяснить номер com порта, присваиваемый станции и выбрать его вместо auto. Также, станции на Arduino Nano с чипами CHG340 могут не работать без установки соответствующего драйвера.

### Подготовка станций

Для настройки станций используются мастер-чипы. Мастер-чип – это обыкновенный чип с записанными на него данными для передачи их на базовую станцию. Чтобы записать мастер-чип, нужно поднести его к мастер-станции и нажать нужную кнопку в зависимости от задачи. Рекомендуется отобрать чип специально для использования в этих целях и как-нибудь его пометить, чтобы избежать попадание его в кучу с чипами участниками, так как в этом случае возможны различные неожиданные ситуации, если чип окажется активным.

Для настройки станций, если они находится в состоянии сна, необходимо их сначала разбудить – поднести любой чип на время до 30 секунд. Произойдет процедура выхода из состояния сна.

### Настройка паролей станции

Для защиты от вандализма и подлога результатов используется система паролей. На станции можно поставить пароль, благодаря которому станция будет реагировать на мастер-чипы только с паролем. 
Кроме того, для чипов можно поставить защиту на запись, что не позволит записывать отметки на чипы произвольной станцией или любым другим устройствам без использования секретного пароля.
Во вкладке Set можно задать пароли – числа от 0 до 255. Для обновления пароля нужно забить старый пароль (по умолчанию 0, 0, 0) и вбить новый. (три значения). Эти пароли используются для мастер-чипов.
Если есть желание использовать защиту чипов от неавторизованной записи, нужно вбить число от 1 до 255 (0 отключает защиту от записи). Пароль на запись будет состоять из пароля станции и данного числа.
Рекомендуется сохранить настройки – Save Set, чтобы не забыть пароли. Потом их можно будет загрузить кнопкой Load Set в случае чего.

Для записи чипа паролей нужно поднести чип к мастер-станции и нажать Pass Card, после чего приложить его к станции отметки. Чип можно использовать многократно (ОСТОРОЖНО! – лучше его специально пометить, либо дазактивировать, записав на него чип участника сразу)

### Настройка времени станции

Для настройки времени нужно приложить чип к мастер-станции и нажать Set Time. Станция издаст три сигнала с интервалом в секунду. После второго сигнала нужно приложить чип к базовой станции. При этом станция издаст 3 сигнала и перезагрузится. Если последний сигнал мастер станции и первый сигнал базовой станции слились в один, то время настроено достаточно точно. Настройку времени лучше проводить в рабочем режиме станции в виду более короткого периода неактивности станции.

Погрешность хода часов (при условии использования качественных компонентов и соблюдения технологии пайки) составляет 1 секунду в неделю. Для критически важных станций – старта, финиша рекомендуется обновлять время в день соревнований.

### Присвоение номера станции

В поле рядом с Set Number набрать номер станции с помощью клавиатуры. Поднести чип к станции и нажать кнопку Set Number. После чего данный чип поднести к станции. Станция издаст сдвоенный сигнал и перезагрузится с новым номером. Для станций старта и финиша – отдельные кнопки. Если поставить галочку Auto++ номер будет увеличиваться на 1 автоматически.

Часть номеров станций используются в специальных целях. Для них зарезервированы отдельные кнопки

* 240 – станция старта – Set Start
* 245 – станция финиша – Set Finish
* 248 – станция проверки – Check St. 
* 249 – станция очистки – Clear St. 

### Перевод станций в спящий режим

После соревнований рекомендуется перевести все станции в спящий режим для продления работы от батарей. Для этого нужно поднести чип к мастер-станции, нажать Sleep Card во вкладке Set и поднести его к базовой станции. Станция издаст сдвоенный сигнал, перезагрузится и войдёт в спящий режим. Для вывода станций из этого режима нужно приложить к ней чип на время до 30 секунд. Чип сна можно использовать повторно (ОСТОРОЖНО! – лучше его специально пометить, либо дазактивировать, записав на него чип участника сразу)

### Измерения напряжения на станции

В станциях версии 3 стоит вольтметр, который позволяет оценить разряд аккумулятора. Для измерения нужно записать чип Status Card во вкладке Set. Поднести его к станции. Станция зажёт светодиод на 5 секунд, после чего измерит напряжение и выдаст его сигналами от 1 до 10, соответственно для 3550 – 4000 мВ, что грубо соответствует шкале разряда. Станции версии 1 будут реагировать на чип сигналом ошибка (три коротких). Чип можно использовать многократно (ОСТОРОЖНО! – лучше его специально пометить, либо дазактивировать, записав на него чип участника сразу)

### Очистка внутренней памяти

Производится с помощью чипа Clean Card во вкладке Set. При поднесении чипа к станции будет производится очистка внутренней памяти, при этом станция будет сигналить, окончание процесса – сдвоенный сигнал. Если станция версии 3, то также будет производится очистка внешней памяти, во время его станция будет сигналить с интервалом в 3 секунды, процесс длительный и занимает около 2 минут. Окончание – сдвоенный сигнал.

### Снятие лога станции

В ходе работы базовая станция ведет лог – записывает факт отметки теми или иными номерам чипов. Время отметки при этом не записывается, лог ведется только для чипов с номерами до 4000. С использованием этой функции возможно восстановление части данных в случае утери чипов, проверки спорных ситуаций, а также в поиске сошедших или потерявшихся участников.

Для снятия лога нужно записать мастер-чип, для этого поднести чип к мастер станции и нажать Dump Card. Процесс подготовки мастер-чипа занимает 5 секунд. После чего поднести мастер чип к базовой станции. Процесс длительный, нужно аккуратно держать чип в оптимальной области записи, при этом станция светит светодидодм. После успешного снятия лога поднести чип к мастер-станции и нажать Read Dump. Результат отобразится в окошке и сохранится в json файле в папке data.

### Снятие полного лога станции

В ходе работы базовая станция версии 3 помимо обычного лога записывает полное время отметки во внешнюю память для чипов с номерами от 1 до 4000.
Для снятия полного лога нужно записать мастер-чип, для этого в поле рядом Full dump ввести номер чипа с которого будет начинаться снятие лога. За раз можно снять данные для 125 чипов номер идут подряд, можно поставить галочку автоматического инкримента, чтобы записывать и считывать последовательно весь диапазон чипов. Далее поднести чип к мастер станции и нажать Full Dump. Процесс подготовки мастер-чипа занимает 5 секунд. После чего поднести мастер чип к базовой станции. Процесс длительный, нужно аккуратно держать чип в оптимальной области записи, при этом станция светит светодидодм. После успешного снятия лога поднести чип к мастер-станции и нажать Read Full. Результат отобразится в окошке и сохранится в json файле в папке data.

### Подготовка чипов.

Пустые чипы необходимо инициализировать (записать на них номер и текущее время). Для этого нужно раскрыть меню настроек – перейти на вкладку Card. После чего вбить номер чипа с помощью клавиатуры (можно использовать только клавиши цифр, расположенные над буквенными, а также кнопки Backspace и delete). Поднести чип к станции и нажать кнопку Init Card. Процесс инициализации занимает в 5 секунд. В случае успеха станция издаст один сигнал, число в поле ввода увеличится на 1, если поставить соответствующую галочку. Если процесс прошел неудачно (три коротких сигнала), попробуйте повторить процедуру.

Номер чипа можно задать в диапазоне от 1 до 65535. Но базовые станции при отметке чипов с номером более 4000 не будут запоминать факт и время их отметки, поэтому рекомендуется ограничиться номерами до 4000.
При инициализации помимо номера чипа записывается и время инициализации, которое необходимо для последующего считывания чипа, если с момента инициализации или очистки прошло более полугода, данные будут некорректными. Поэтому желательно инициализировать чипы не за долго до соревнований.

Уже ранее инициализированные чипы можно очистить с сохранением номера на станции очистки (нужно присвоить базовой станции номер 249, а также обновить на станции время).
Для включения пароля на запись необходимо его предварительно выставить на станции сопряжения – для этого нужно записать мастер-чип паролей. 

### Чтение чипов.

Чтение чипов производится во вкладке Read. Нужно поднести чип к станции и нажать Read, после успешного чтения результат отобразится на экране, а также сохранится в json-файл в папке data.
Если нужно, можно подключить принтер и печатать данные, выводимые на экран, в том числе автоматически, если поставить соответствующую галочку.
С помощью кнопки read raw можно считать сырые данные с чипа для его диагностики.